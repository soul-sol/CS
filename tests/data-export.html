<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Firebase ë°ì´í„° ë‚´ë³´ë‚´ê¸°</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .export-button {
            background-color: #28a745;
        }
        .export-button:hover {
            background-color: #218838;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Firebase ë°ì´í„° ê´€ë¦¬</h1>
    
    <div class="section">
        <h2>ğŸ“Š ë°ì´í„° ìš”ì•½</h2>
        <div id="summary"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ”§ ë°ì´í„° ì •ë¦¬</h2>
        <button onclick="removeUndefined()">undefined ë©¤ë²„ ì œê±°</button>
        <button onclick="cleanupData()">ì¤‘ë³µ ë°ì´í„° ì •ë¦¬</button>
        <button onclick="updateMissingStats()">ìŠ¤íƒ¯ ì—†ëŠ” ë©¤ë²„ ì—…ë°ì´íŠ¸</button>
        <div id="cleanup-result"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h2>
        <button class="export-button" onclick="exportJSON()">JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
        <button class="export-button" onclick="exportCSV()">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
        <button class="export-button" onclick="exportBackup()">ì „ì²´ ë°±ì—…</button>
    </div>
    
    <div class="section">
        <h2>ğŸ“‹ ë©¤ë²„ ëª©ë¡</h2>
        <div id="member-table"></div>
    </div>
    
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDKLNkEgvT9x5HqZTDQoR_4vvJLZpTQPxE",
            authDomain: "cs-homepage-5c3c2.firebaseapp.com",
            databaseURL: "https://cs-homepage-5c3c2-default-rtdb.firebaseio.com",
            projectId: "cs-homepage-5c3c2",
            storageBucket: "cs-homepage-5c3c2.appspot.com",
            messagingSenderId: "297914930278",
            appId: "1:297914930278:web:d0b96e0b5e9c9c5f8f8f8f"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentData = {};
        
        async function loadData() {
            const membersRef = database.ref('members');
            const snapshot = await membersRef.once('value');
            currentData = snapshot.val() || {};
            displaySummary();
            displayMemberTable();
        }
        
        function displaySummary() {
            const members = Object.entries(currentData);
            const online = members.filter(([k, m]) => !m.status || m.status === 'online').length;
            const offline = members.filter(([k, m]) => m.status && m.status !== 'online').length;
            const withStats = members.filter(([k, m]) => m.stats && m.stats.kda && m.stats.kda !== '0.0').length;
            const withoutStats = members.filter(([k, m]) => !m.stats || !m.stats.kda || m.stats.kda === '0.0').length;
            const invalidIds = members.filter(([k, m]) => k === 'undefined' || !m.name).length;
            
            document.getElementById('summary').innerHTML = `
                <p>ì´ ë©¤ë²„ ìˆ˜: <strong>${members.length}</strong>ëª…</p>
                <p>ì˜¨ë¼ì¸: <span class="success">${online}</span>ëª… / ì˜¤í”„ë¼ì¸: <span class="warning">${offline}</span>ëª…</p>
                <p>ìŠ¤íƒ¯ ìˆìŒ: <span class="success">${withStats}</span>ëª… / ìŠ¤íƒ¯ ì—†ìŒ: <span class="warning">${withoutStats}</span>ëª…</p>
                ${invalidIds > 0 ? `<p class="error">âš ï¸ ì˜ëª»ëœ ë°ì´í„°: ${invalidIds}ê°œ</p>` : ''}
            `;
        }
        
        function displayMemberTable() {
            const members = Object.entries(currentData);
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>í‹°ì–´</th>
                            <th>ìƒíƒœ</th>
                            <th>KDA</th>
                            <th>í‰ê·  ë°ë¯¸ì§€</th>
                            <th>Firebase Key</th>
                            <th>ë¬¸ì œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            members.forEach(([key, member]) => {
                const problems = [];
                if (key === 'undefined' || !member.name) problems.push('ì˜ëª»ëœ ID');
                if (!member.stats || !member.stats.kda || member.stats.kda === '0.0') problems.push('ìŠ¤íƒ¯ ì—†ìŒ');
                
                html += `
                    <tr>
                        <td>${member.name || 'undefined'}</td>
                        <td>${member.tier || '-'}</td>
                        <td>${member.status || 'online'}</td>
                        <td>${member.stats?.kda || '-'}</td>
                        <td>${member.stats?.avgDamage || '-'}</td>
                        <td style="font-size: 0.8em">${key}</td>
                        <td>${problems.length > 0 ? `<span class="error">${problems.join(', ')}</span>` : 'âœ…'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('member-table').innerHTML = html;
        }
        
        async function removeUndefined() {
            const result = document.getElementById('cleanup-result');
            result.innerHTML = 'ì²˜ë¦¬ ì¤‘...';
            
            try {
                const membersRef = database.ref('members');
                const removeTasks = [];
                let count = 0;
                
                for (const [key, member] of Object.entries(currentData)) {
                    if (key === 'undefined' || !member || !member.name || member.name === 'undefined') {
                        removeTasks.push(membersRef.child(key).remove());
                        count++;
                    }
                }
                
                await Promise.all(removeTasks);
                result.innerHTML = `<span class="success">âœ… ${count}ê°œì˜ ì˜ëª»ëœ ë°ì´í„°ë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.</span>`;
                await loadData();
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }
        
        async function cleanupData() {
            const result = document.getElementById('cleanup-result');
            result.innerHTML = 'ë°ì´í„° ì •ë¦¬ ì¤‘...';
            
            try {
                const membersRef = database.ref('members');
                const nameMap = {};
                const duplicates = [];
                
                // ì¤‘ë³µ ì°¾ê¸°
                for (const [key, member] of Object.entries(currentData)) {
                    if (member.name) {
                        if (nameMap[member.name]) {
                            duplicates.push({ key, member });
                        } else {
                            nameMap[member.name] = { key, member };
                        }
                    }
                }
                
                // ì¤‘ë³µ ì œê±° (ìµœì‹  ë°ì´í„° ìœ ì§€)
                for (const dup of duplicates) {
                    const original = nameMap[dup.member.name];
                    const origUpdate = new Date(original.member.lastStatsUpdate || 0);
                    const dupUpdate = new Date(dup.member.lastStatsUpdate || 0);
                    
                    if (dupUpdate > origUpdate) {
                        // ì¤‘ë³µì´ ë” ìµœì‹ ì´ë©´ ì›ë³¸ ì‚­ì œ
                        await membersRef.child(original.key).remove();
                        nameMap[dup.member.name] = dup;
                    } else {
                        // ì›ë³¸ì´ ë” ìµœì‹ ì´ë©´ ì¤‘ë³µ ì‚­ì œ
                        await membersRef.child(dup.key).remove();
                    }
                }
                
                result.innerHTML = `<span class="success">âœ… ${duplicates.length}ê°œì˜ ì¤‘ë³µ ë°ì´í„°ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.</span>`;
                await loadData();
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(currentData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-members-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCSV() {
            let csv = 'Name,Tier,Status,KDA,Avg Damage,Rounds Played,Wins,Firebase Key\n';
            
            for (const [key, member] of Object.entries(currentData)) {
                csv += `"${member.name || ''}","${member.tier || ''}","${member.status || 'online'}",`;
                csv += `"${member.stats?.kda || '0'}","${member.stats?.avgDamage || '0'}",`;
                csv += `"${member.stats?.roundsPlayed || '0'}","${member.stats?.wins || '0'}","${key}"\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-members-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function exportBackup() {
            try {
                const rootRef = database.ref();
                const snapshot = await rootRef.once('value');
                const allData = snapshot.val();
                
                const dataStr = JSON.stringify(allData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `firebase-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('ì „ì²´ Firebase ë°ì´í„° ë°±ì—… ì™„ë£Œ!');
            } catch (error) {
                alert('ë°±ì—… ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        async function updateMissingStats() {
            const result = document.getElementById('cleanup-result');
            result.innerHTML = '<span class="warning">ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ëŠ” ë³„ë„ í˜ì´ì§€ì—ì„œ ì§„í–‰í•˜ì„¸ìš”: /tests/update-missing-stats.html</span>';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        loadData();
    </script>
</body>
</html>
