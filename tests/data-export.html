<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Firebase 데이터 내보내기</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .export-button {
            background-color: #28a745;
        }
        .export-button:hover {
            background-color: #218838;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Firebase 데이터 관리</h1>
    
    <div class="section">
        <h2>📊 데이터 요약</h2>
        <div id="summary"></div>
    </div>
    
    <div class="section">
        <h2>🔧 데이터 정리</h2>
        <button onclick="removeUndefined()">undefined 멤버 제거</button>
        <button onclick="cleanupData()">중복 데이터 정리</button>
        <button onclick="updateMissingStats()">스탯 없는 멤버 업데이트</button>
        <div id="cleanup-result"></div>
    </div>
    
    <div class="section">
        <h2>💾 데이터 내보내기</h2>
        <button class="export-button" onclick="exportJSON()">JSON으로 내보내기</button>
        <button class="export-button" onclick="exportCSV()">CSV로 내보내기</button>
        <button class="export-button" onclick="exportBackup()">전체 백업</button>
    </div>
    
    <div class="section">
        <h2>📋 멤버 목록</h2>
        <div id="member-table"></div>
    </div>
    
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDKLNkEgvT9x5HqZTDQoR_4vvJLZpTQPxE",
            authDomain: "cs-homepage-5c3c2.firebaseapp.com",
            databaseURL: "https://cs-homepage-5c3c2-default-rtdb.firebaseio.com",
            projectId: "cs-homepage-5c3c2",
            storageBucket: "cs-homepage-5c3c2.appspot.com",
            messagingSenderId: "297914930278",
            appId: "1:297914930278:web:d0b96e0b5e9c9c5f8f8f8f"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentData = {};
        
        async function loadData() {
            const membersRef = database.ref('members');
            const snapshot = await membersRef.once('value');
            currentData = snapshot.val() || {};
            displaySummary();
            displayMemberTable();
        }
        
        function displaySummary() {
            const members = Object.entries(currentData);
            const online = members.filter(([k, m]) => !m.status || m.status === 'online').length;
            const offline = members.filter(([k, m]) => m.status && m.status !== 'online').length;
            const withStats = members.filter(([k, m]) => m.stats && m.stats.kda && m.stats.kda !== '0.0').length;
            const withoutStats = members.filter(([k, m]) => !m.stats || !m.stats.kda || m.stats.kda === '0.0').length;
            const invalidIds = members.filter(([k, m]) => k === 'undefined' || !m.name).length;
            
            document.getElementById('summary').innerHTML = `
                <p>총 멤버 수: <strong>${members.length}</strong>명</p>
                <p>온라인: <span class="success">${online}</span>명 / 오프라인: <span class="warning">${offline}</span>명</p>
                <p>스탯 있음: <span class="success">${withStats}</span>명 / 스탯 없음: <span class="warning">${withoutStats}</span>명</p>
                ${invalidIds > 0 ? `<p class="error">⚠️ 잘못된 데이터: ${invalidIds}개</p>` : ''}
            `;
        }
        
        function displayMemberTable() {
            const members = Object.entries(currentData);
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>티어</th>
                            <th>상태</th>
                            <th>KDA</th>
                            <th>평균 데미지</th>
                            <th>Firebase Key</th>
                            <th>문제</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            members.forEach(([key, member]) => {
                const problems = [];
                if (key === 'undefined' || !member.name) problems.push('잘못된 ID');
                if (!member.stats || !member.stats.kda || member.stats.kda === '0.0') problems.push('스탯 없음');
                
                html += `
                    <tr>
                        <td>${member.name || 'undefined'}</td>
                        <td>${member.tier || '-'}</td>
                        <td>${member.status || 'online'}</td>
                        <td>${member.stats?.kda || '-'}</td>
                        <td>${member.stats?.avgDamage || '-'}</td>
                        <td style="font-size: 0.8em">${key}</td>
                        <td>${problems.length > 0 ? `<span class="error">${problems.join(', ')}</span>` : '✅'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('member-table').innerHTML = html;
        }
        
        async function removeUndefined() {
            const result = document.getElementById('cleanup-result');
            result.innerHTML = '처리 중...';
            
            try {
                const membersRef = database.ref('members');
                const removeTasks = [];
                let count = 0;
                
                for (const [key, member] of Object.entries(currentData)) {
                    if (key === 'undefined' || !member || !member.name || member.name === 'undefined') {
                        removeTasks.push(membersRef.child(key).remove());
                        count++;
                    }
                }
                
                await Promise.all(removeTasks);
                result.innerHTML = `<span class="success">✅ ${count}개의 잘못된 데이터를 제거했습니다.</span>`;
                await loadData();
            } catch (error) {
                result.innerHTML = `<span class="error">❌ 오류: ${error.message}</span>`;
            }
        }
        
        async function cleanupData() {
            const result = document.getElementById('cleanup-result');
            result.innerHTML = '데이터 정리 중...';
            
            try {
                const membersRef = database.ref('members');
                const nameMap = {};
                const duplicates = [];
                
                // 중복 찾기
                for (const [key, member] of Object.entries(currentData)) {
                    if (member.name) {
                        if (nameMap[member.name]) {
                            duplicates.push({ key, member });
                        } else {
                            nameMap[member.name] = { key, member };
                        }
                    }
                }
                
                // 중복 제거 (최신 데이터 유지)
                for (const dup of duplicates) {
                    const original = nameMap[dup.member.name];
                    const origUpdate = new Date(original.member.lastStatsUpdate || 0);
                    const dupUpdate = new Date(dup.member.lastStatsUpdate || 0);
                    
                    if (dupUpdate > origUpdate) {
                        // 중복이 더 최신이면 원본 삭제
                        await membersRef.child(original.key).remove();
                        nameMap[dup.member.name] = dup;
                    } else {
                        // 원본이 더 최신이면 중복 삭제
                        await membersRef.child(dup.key).remove();
                    }
                }
                
                result.innerHTML = `<span class="success">✅ ${duplicates.length}개의 중복 데이터를 정리했습니다.</span>`;
                await loadData();
            } catch (error) {
                result.innerHTML = `<span class="error">❌ 오류: ${error.message}</span>`;
            }
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(currentData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-members-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCSV() {
            let csv = 'Name,Tier,Status,KDA,Avg Damage,Rounds Played,Wins,Firebase Key\n';
            
            for (const [key, member] of Object.entries(currentData)) {
                csv += `"${member.name || ''}","${member.tier || ''}","${member.status || 'online'}",`;
                csv += `"${member.stats?.kda || '0'}","${member.stats?.avgDamage || '0'}",`;
                csv += `"${member.stats?.roundsPlayed || '0'}","${member.stats?.wins || '0'}","${key}"\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-members-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function exportBackup() {
            try {
                const rootRef = database.ref();
                const snapshot = await rootRef.once('value');
                const allData = snapshot.val();
                
                const dataStr = JSON.stringify(allData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `firebase-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('전체 Firebase 데이터 백업 완료!');
            } catch (error) {
                alert('백업 실패: ' + error.message);
            }
        }
        
        async function updateMissingStats() {
            const result = document.getElementById('cleanup-result');
            result.innerHTML = '<span class="warning">스탯 업데이트는 별도 페이지에서 진행하세요: /tests/update-missing-stats.html</span>';
        }
        
        // 페이지 로드 시 데이터 로드
        loadData();
    </script>
</body>
</html>
