<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>스탯 없는 멤버 업데이트</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .member-update {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .processing { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>스탯 없는 멤버 업데이트</h1>
    <button onclick="updateMissingStats()">업데이트 시작</button>
    <div id="output"></div>
    
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDKLNkEgvT9x5HqZTDQoR_4vvJLZpTQPxE",
            authDomain: "cs-homepage-5c3c2.firebaseapp.com",
            databaseURL: "https://cs-homepage-5c3c2-default-rtdb.firebaseio.com",
            projectId: "cs-homepage-5c3c2",
            storageBucket: "cs-homepage-5c3c2.appspot.com",
            messagingSenderId: "297914930278",
            appId: "1:297914930278:web:d0b96e0b5e9c9c5f8f8f8f"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const output = document.getElementById('output');
        
        // PUBG API 설정
        const PUBG_API_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJlNmRiNmI4MC04MjVkLTAxM2QtNjJmNS0wM2VjMjBmOGUzMzciLCJpc3MiOiJnYW1lbG9ja2VyIiwiaWF0IjoxNzMzMjQ0Mzc1LCJwdWIiOiJibHVlaG9sZSIsInRpdGxlIjoicHViZyIsImFwcCI6ImNzLWhvbWVwYWdlIn0.fvXGlOp0IQCrDRaUK3k1pdJFHvJQs8rDVMcaxV5_sOA';
        const SEASON_ID = 'division.bro.official.pc-2018-33';
        
        function log(message, className = '') {
            console.log(message);
            const div = document.createElement('div');
            div.className = className;
            div.innerHTML = message;
            output.appendChild(div);
        }
        
        async function fetchPlayerStats(playerId, playerName) {
            try {
                const response = await fetch(
                    `https://api.pubg.com/shards/steam/players/${playerId}/seasons/${SEASON_ID}/ranked`,
                    {
                        headers: {
                            'Authorization': `Bearer ${PUBG_API_KEY}`,
                            'Accept': 'application/vnd.api+json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`API 응답 오류: ${response.status}`);
                }
                
                const data = await response.json();
                const squadStats = data.data.attributes.rankedGameModeStats['squad-fpp'];
                
                if (squadStats && squadStats.roundsPlayed > 0) {
                    const kda = squadStats.deaths > 0 
                        ? ((squadStats.kills + squadStats.assists) / squadStats.deaths).toFixed(2)
                        : squadStats.kills.toFixed(2);
                    
                    const avgDamage = squadStats.roundsPlayed > 0
                        ? Math.round(squadStats.damageDealt / squadStats.roundsPlayed)
                        : 0;
                    
                    return {
                        kills: squadStats.kills,
                        deaths: squadStats.deaths,
                        assists: squadStats.assists,
                        kda: kda,
                        kd: (squadStats.deaths > 0 ? (squadStats.kills / squadStats.deaths).toFixed(2) : squadStats.kills.toFixed(2)),
                        avgKills: (squadStats.kills / squadStats.roundsPlayed).toFixed(2),
                        damageDealt: squadStats.damageDealt,
                        avgDamage: avgDamage,
                        roundsPlayed: squadStats.roundsPlayed,
                        wins: squadStats.wins,
                        winRate: ((squadStats.wins / squadStats.roundsPlayed) * 100).toFixed(1),
                        tier: squadStats.currentTier?.tier || 'Unranked',
                        top10s: squadStats.top10s || 0,
                        headshotKills: squadStats.headshotKills || 0,
                        longestKill: squadStats.longestKill || 0
                    };
                }
                
                return null;
            } catch (error) {
                console.error(`${playerName} 스탯 가져오기 실패:`, error);
                return null;
            }
        }
        
        async function updateMissingStats() {
            log('🚀 스탯 없는 멤버 업데이트 시작...', 'member-update processing');
            
            try {
                const membersRef = database.ref('members');
                const snapshot = await membersRef.once('value');
                const members = snapshot.val() || {};
                
                const needsUpdate = [];
                for (const [key, member] of Object.entries(members)) {
                    if (!member.stats || !member.stats.kda || member.stats.kda === '0.0') {
                        needsUpdate.push({ key, member });
                    }
                }
                
                log(`📊 ${needsUpdate.length}명의 멤버 스탯 업데이트 필요`, 'member-update');
                
                for (const { key, member } of needsUpdate) {
                    log(`👤 ${member.name} 업데이트 중...`, 'member-update processing');
                    
                    const playerId = member.originalId || member.pubgId || key;
                    const cleanId = playerId.replace('account_', 'account.');
                    
                    const stats = await fetchPlayerStats(cleanId, member.name);
                    
                    if (stats) {
                        await membersRef.child(key).update({
                            stats: stats,
                            lastStatsUpdate: new Date().toISOString()
                        });
                        log(`✅ ${member.name} 업데이트 성공 - KDA: ${stats.kda}, DMG: ${stats.avgDamage}`, 'member-update success');
                    } else {
                        log(`⚠️ ${member.name} - 랭크 스탯 없음`, 'member-update error');
                    }
                    
                    // API 제한 방지를 위한 딜레이
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                log('<br>✨ 모든 업데이트 완료!', 'member-update success');
                
            } catch (error) {
                log(`❌ 오류 발생: ${error.message}`, 'member-update error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
