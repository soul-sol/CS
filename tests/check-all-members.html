<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „ì²´ ë©¤ë²„ ID ì ê²€</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #0a0a0a; 
            color: #0f0;
        }
        h1 { color: #fff; }
        .member-check {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
            background: #1a1a1a;
        }
        .valid { border-color: #4CAF50; }
        .invalid { border-color: #f44336; background: #2a1515; }
        .stats-ok { color: #4CAF50; }
        .stats-missing { color: #ff9800; }
        .id-ok { color: #4CAF50; }
        .id-bad { color: #f44336; }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        .summary {
            margin: 20px 0;
            padding: 15px;
            background: #1a1a1a;
            border: 2px solid #4CAF50;
        }
        pre { 
            background: #000; 
            padding: 10px; 
            overflow: auto;
            color: #0f0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ì „ì²´ ë©¤ë²„ Firebase ë°ì´í„° ì ê²€</h1>
    
    <button onclick="checkAllMembers()">ì „ì²´ ë©¤ë²„ ì ê²€</button>
    <button onclick="fixProblems()">ë¬¸ì œ ìë™ ìˆ˜ì •</button>
    <button onclick="exportData()">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
    
    <div id="summary" class="summary"></div>
    <div id="results"></div>
    <pre id="exportArea" style="display:none;"></pre>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCWEWmussrZcqv4LgCvjUdcuzRcaUST3Ls",
            authDomain: "cs-homepage-5c3c2.firebaseapp.com",
            databaseURL: "https://cs-homepage-5c3c2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cs-homepage-5c3c2",
            storageBucket: "cs-homepage-5c3c2.firebasestorage.app",
            messagingSenderId: "117726976721",
            appId: "1:117726976721:web:f9dd3297e82113414183f0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let allMembers = {};
        let problemMembers = [];
        
        window.checkAllMembers = async function() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            resultsDiv.innerHTML = '';
            summaryDiv.innerHTML = '<h2>ì ê²€ ì¤‘...</h2>';
            
            try {
                const snapshot = await get(ref(database, 'members'));
                allMembers = snapshot.val();
                
                if (!allMembers) {
                    resultsDiv.innerHTML = '<div class="invalid">ë©¤ë²„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!</div>';
                    return;
                }
                
                let totalCount = 0;
                let validIdCount = 0;
                let invalidIdCount = 0;
                let withStatsCount = 0;
                let withoutStatsCount = 0;
                let onlineCount = 0;
                let offlineCount = 0;
                problemMembers = [];
                
                // ë©¤ë²„ë³„ ì²´í¬
                Object.entries(allMembers).forEach(([firebaseKey, member]) => {
                    totalCount++;
                    
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'member-check';
                    
                    let issues = [];
                    
                    // ID ì²´í¬
                    const hasValidOriginalId = member.originalId && member.originalId.startsWith('account.');
                    const hasValidPubgId = member.pubgId && member.pubgId.startsWith('account.');
                    const hasValidId = hasValidOriginalId || hasValidPubgId;
                    
                    if (hasValidId) {
                        validIdCount++;
                    } else {
                        invalidIdCount++;
                        issues.push('ID ë¬¸ì œ');
                        problemMembers.push({
                            key: firebaseKey,
                            name: member.name,
                            issue: 'NO_VALID_ID'
                        });
                    }
                    
                    // ìŠ¤íƒ¯ ì²´í¬
                    const hasStats = member.stats && 
                                   (member.stats.kda !== '0.0' || 
                                    member.stats.avgDamage > 0 ||
                                    member.stats.roundsPlayed > 0);
                    
                    if (hasStats) {
                        withStatsCount++;
                    } else {
                        withoutStatsCount++;
                        issues.push('ìŠ¤íƒ¯ ì—†ìŒ');
                    }
                    
                    // ìƒíƒœ ì²´í¬
                    if (!member.status || member.status === 'online') {
                        onlineCount++;
                    } else {
                        offlineCount++;
                    }
                    
                    // Firebase Keyì™€ ID ì¼ì¹˜ ì²´í¬
                    const expectedKey = firebaseKey.replace(/_/g, '.');
                    const idMatches = (member.originalId === expectedKey) || 
                                     (member.pubgId === expectedKey);
                    
                    // ê²°ê³¼ í‘œì‹œ
                    memberDiv.className = issues.length > 0 ? 'member-check invalid' : 'member-check valid';
                    
                    memberDiv.innerHTML = `
                        <strong>${totalCount}. ${member.name}</strong> 
                        <span style="color: #666;">[${member.tier || 'unassigned'}]</span><br>
                        Firebase Key: <code>${firebaseKey}</code><br>
                        Original ID: <span class="${hasValidOriginalId ? 'id-ok' : 'id-bad'}">${member.originalId || 'NONE'}</span><br>
                        PUBG ID: <span class="${hasValidPubgId ? 'id-ok' : 'id-bad'}">${member.pubgId || 'NONE'}</span><br>
                        ìŠ¤íƒ¯: <span class="${hasStats ? 'stats-ok' : 'stats-missing'}">
                            ${hasStats ? `KDA: ${member.stats.kda}, DMG: ${member.stats.avgDamage}` : 'NO STATS'}
                        </span><br>
                        ìƒíƒœ: ${member.status || 'online'}<br>
                        ${issues.length > 0 ? `<span style="color: #f44336;">âš ï¸ ë¬¸ì œ: ${issues.join(', ')}</span>` : 'âœ… ì •ìƒ'}
                    `;
                    
                    resultsDiv.appendChild(memberDiv);
                });
                
                // ìš”ì•½ í‘œì‹œ
                summaryDiv.innerHTML = `
                    <h2>ğŸ“Š ì ê²€ ê²°ê³¼ ìš”ì•½</h2>
                    <div>ì´ ë©¤ë²„ ìˆ˜: <strong>${totalCount}ëª…</strong></div>
                    <div>ì˜¨ë¼ì¸: <strong>${onlineCount}ëª…</strong> / ì˜¤í”„ë¼ì¸: <strong>${offlineCount}ëª…</strong></div>
                    <div style="color: ${validIdCount === totalCount ? '#4CAF50' : '#ff9800'}">
                        ìœ íš¨í•œ ID: <strong>${validIdCount}ëª…</strong> / 
                        ë¬¸ì œ ìˆëŠ” ID: <strong style="color: #f44336">${invalidIdCount}ëª…</strong>
                    </div>
                    <div>ìŠ¤íƒ¯ ìˆìŒ: <strong>${withStatsCount}ëª…</strong> / 
                         ìŠ¤íƒ¯ ì—†ìŒ: <strong>${withoutStatsCount}ëª…</strong>
                    </div>
                    ${problemMembers.length > 0 ? 
                        `<div style="color: #f44336; margin-top: 10px;">
                            âš ï¸ ìˆ˜ì •ì´ í•„ìš”í•œ ë©¤ë²„: ${problemMembers.length}ëª…<br>
                            ${problemMembers.map(p => p.name).join(', ')}
                        </div>` : 
                        '<div style="color: #4CAF50; margin-top: 10px;">âœ… ëª¨ë“  ë©¤ë²„ ì •ìƒ!</div>'
                    }
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="invalid">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
            }
        }
        
        window.fixProblems = async function() {
            if (problemMembers.length === 0) {
                alert('ìˆ˜ì •í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (!confirm(`${problemMembers.length}ëª…ì˜ ë©¤ë²„ ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            const updates = {};
            
            for (const problem of problemMembers) {
                if (problem.issue === 'NO_VALID_ID') {
                    // ì´ë¦„ìœ¼ë¡œ PUBG API ê²€ìƒ‰í•´ì„œ ID ì°¾ê¸° (ì‹¤ì œ êµ¬í˜„ í•„ìš”)
                    console.log(`${problem.name}ì˜ IDë¥¼ ì°¾ì•„ì•¼ í•¨`);
                    // ì„ì‹œë¡œ Firebase Keyë¥¼ IDë¡œ ë³€í™˜
                    const probableId = problem.key.replace(/_/g, '.');
                    if (probableId.startsWith('account.')) {
                        updates[`members/${problem.key}/originalId`] = probableId;
                        updates[`members/${problem.key}/pubgId`] = probableId;
                    }
                }
            }
            
            if (Object.keys(updates).length > 0) {
                try {
                    await update(ref(database), updates);
                    alert('ìˆ˜ì • ì™„ë£Œ! ë‹¤ì‹œ ì ê²€í•´ì£¼ì„¸ìš”.');
                    checkAllMembers();
                } catch (error) {
                    alert('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message);
                }
            }
        }
        
        window.exportData = function() {
            const exportArea = document.getElementById('exportArea');
            exportArea.style.display = 'block';
            exportArea.textContent = JSON.stringify(allMembers, null, 2);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('load', () => {
            checkAllMembers();
        });
    </script>
</body>
</html>
