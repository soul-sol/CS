<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Builder AND 조건 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #222;
        }
        h2 {
            color: #00aaff;
        }
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .team-card {
            padding: 15px;
            border: 2px solid #444;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .team-card.valid {
            border-color: #00ff00;
        }
        .team-card.invalid {
            border-color: #ff0000;
        }
        .team-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .member {
            padding: 5px;
            margin: 3px 0;
            border-radius: 4px;
        }
        .tier1 { background: #4a4a00; color: #ffff00; }
        .tier2 { background: #4a0000; color: #ff6666; }
        .tier3 { background: #004a00; color: #66ff66; }
        .tier4 { background: #00004a; color: #6666ff; }
        .unassigned { background: #333; color: #aaa; }
        .validation {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .validation.pass {
            background: #004400;
            color: #00ff00;
        }
        .validation.fail {
            background: #440000;
            color: #ff0000;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #333;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #444;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .success { background: #004400; color: #00ff00; }
        .error { background: #440000; color: #ff0000; }
        .info { background: #000044; color: #00aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Team Builder AND 조건 테스트</h1>
        
        <div class="test-section">
            <h2>테스트 시나리오</h2>
            <button onclick="runTest()">AND 조건 테스트 실행</button>
            <div id="status"></div>
        </div>

        <div class="test-section">
            <h2>팀 구성 결과</h2>
            <div id="teamResults"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCWEWmussrZcqv4LgCvjUdcuzRcaUST3Ls",
            authDomain: "cs-homepage-5c3c2.firebaseapp.com",
            databaseURL: "https://cs-homepage-5c3c2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cs-homepage-5c3c2",
            storageBucket: "cs-homepage-5c3c2.firebasestorage.app",
            messagingSenderId: "117726976721",
            appId: "1:117726976721:web:f9dd3297e82113414183f0",
            measurementId: "G-9XZ9SJ3D78"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let members = {};
        
        // Firebase 데이터 로드
        onValue(ref(database, 'members'), (snapshot) => {
            members = snapshot.val() || {};
            showStatus('Firebase 데이터 로드 완료', 'success');
        });
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 개선된 팀 생성 함수 (AND 조건 적용)
        function createTeamsWithAND(membersList, teamCount) {
            const teams = Array.from({ length: teamCount }, () => []);
            let availableMembers = [...membersList];
            
            // 1단계: 1티어 배치 (각 팀에 하나씩)
            const tier1Members = availableMembers.filter(m => m.tier === 'tier1');
            let otherMembers = availableMembers.filter(m => m.tier !== 'tier1');
            
            tier1Members.forEach((member, index) => {
                if (index < teamCount) {
                    teams[index].push(member);
                } else {
                    // 남은 1티어는 가장 적은 팀에 배치
                    let minTeamIndex = 0;
                    let minTeamSize = teams[0].length;
                    for (let i = 1; i < teamCount; i++) {
                        if (teams[i].length < minTeamSize) {
                            minTeamSize = teams[i].length;
                            minTeamIndex = i;
                        }
                    }
                    teams[minTeamIndex].push(member);
                }
            });
            
            availableMembers = otherMembers;
            
            // 2단계: 2티어 배치 (각 팀에 하나씩)
            const tier2Members = availableMembers.filter(m => m.tier === 'tier2');
            otherMembers = availableMembers.filter(m => m.tier !== 'tier2');
            
            tier2Members.forEach((member, index) => {
                if (index < teamCount) {
                    // 각 팀에 하나씩 배치
                    teams[index].push(member);
                } else {
                    // 남은 2티어는 가장 적은 팀에 배치
                    let minTeamIndex = 0;
                    let minTeamSize = teams[0].length;
                    for (let i = 1; i < teamCount; i++) {
                        if (teams[i].length < minTeamSize) {
                            minTeamSize = teams[i].length;
                            minTeamIndex = i;
                        }
                    }
                    teams[minTeamIndex].push(member);
                }
            });
            
            availableMembers = otherMembers;
            
            // 3단계: 나머지 멤버 균등 배치
            availableMembers.forEach(member => {
                let minTeamIndex = 0;
                let minTeamSize = teams[0].length;
                for (let i = 1; i < teamCount; i++) {
                    if (teams[i].length < minTeamSize) {
                        minTeamSize = teams[i].length;
                        minTeamIndex = i;
                    }
                }
                teams[minTeamIndex].push(member);
            });
            
            return teams;
        }
        
        // 팀 검증 함수
        function validateTeam(team) {
            const hasTier1 = team.some(m => m.tier === 'tier1');
            const hasTier2 = team.some(m => m.tier === 'tier2');
            return { hasTier1, hasTier2, isValid: hasTier1 && hasTier2 };
        }
        
        // 티어 이름 가져오기
        function getTierName(tier) {
            switch(tier) {
                case 'tier1': return '1티어';
                case 'tier2': return '2티어';
                case 'tier3': return '3티어';
                case 'tier4': return '4티어';
                default: return '무소속';
            }
        }
        
        // 티어 클래스 가져오기
        function getTierClass(tier) {
            switch(tier) {
                case 'tier1': return 'tier1';
                case 'tier2': return 'tier2';
                case 'tier3': return 'tier3';
                case 'tier4': return 'tier4';
                default: return 'unassigned';
            }
        }
        
        window.runTest = function() {
            const onlineMembers = Object.values(members).filter(m => !m.status || m.status === 'online');
            
            if (onlineMembers.length === 0) {
                showStatus('온라인 멤버가 없습니다.', 'error');
                return;
            }
            
            const teamCount = 4;
            const teams = createTeamsWithAND(onlineMembers, teamCount);
            
            let html = '<div class="team-grid">';
            let allValid = true;
            
            teams.forEach((team, index) => {
                const validation = validateTeam(team);
                if (!validation.isValid) allValid = false;
                
                const tierCounts = {};
                team.forEach(m => {
                    const tier = m.tier || 'unassigned';
                    tierCounts[tier] = (tierCounts[tier] || 0) + 1;
                });
                
                html += `
                    <div class="team-card ${validation.isValid ? 'valid' : 'invalid'}">
                        <div class="team-header">Team ${index + 1} (${team.length}명)</div>
                        <div style="font-size: 14px; color: #888; margin-bottom: 10px;">
                            ${Object.entries(tierCounts).map(([tier, count]) => 
                                `${getTierName(tier)}: ${count}`
                            ).join(' | ')}
                        </div>
                        ${team.map(member => `
                            <div class="member ${getTierClass(member.tier)}">
                                ${member.tier === 'tier1' ? '👑' : ''}
                                ${member.tier === 'tier2' ? '🔥' : ''}
                                ${member.tier === 'tier3' ? '🌟' : ''}
                                ${member.tier === 'tier4' ? '⚔️' : ''}
                                ${!member.tier || member.tier === 'unassigned' ? '📋' : ''}
                                ${member.name}
                            </div>
                        `).join('')}
                        <div class="validation ${validation.isValid ? 'pass' : 'fail'}">
                            1티어: ${validation.hasTier1 ? '✅' : '❌'} | 
                            2티어: ${validation.hasTier2 ? '✅' : '❌'}
                            ${validation.isValid ? ' → AND 조건 충족 ✅' : ' → AND 조건 미충족 ❌'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (allValid) {
                html += '<div class="validation pass" style="margin-top: 20px; text-align: center; font-size: 18px;">✅ 모든 팀이 AND 조건을 충족합니다! (각 팀에 1티어와 2티어가 모두 있음)</div>';
            } else {
                html += '<div class="validation fail" style="margin-top: 20px; text-align: center; font-size: 18px;">❌ 일부 팀이 AND 조건을 충족하지 못했습니다!</div>';
            }
            
            document.getElementById('teamResults').innerHTML = html;
            showStatus(`테스트 완료: ${allValid ? '성공' : '실패'}`, allValid ? 'success' : 'error');
        };
    </script>
</body>
</html>


